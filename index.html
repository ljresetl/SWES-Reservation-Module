<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SWES Reservation Module</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
/* Sticky table header */
.table-responsive { max-height: 400px; overflow-y: auto; }
.table thead th { position: sticky; top: 0; background-color: #fff; z-index: 1; }
/* Card view for mobile */
@media (max-width: 768px) {
    .table-responsive table, .table-responsive thead, .table-responsive tbody, .table-responsive th, .table-responsive td, .table-responsive tr { display: block; }
    .table-responsive tr { margin-bottom: 1rem; border: 1px solid #ddd; padding: 0.5rem; border-radius: 5px; }
    .table-responsive td { border: none; padding-left: 50%; position: relative; }
    .table-responsive td::before { position: absolute; left: 10px; top: 0; white-space: nowrap; font-weight: bold; }
    td:nth-of-type(1)::before { content: "Дата"; }
    td:nth-of-type(2)::before { content: "Обладнання"; }
    td:nth-of-type(3)::before { content: "Статус"; }
    td:nth-of-type(4)::before { content: "Дата повернення"; }
}
</style>
</head>
<body class="p-4">

<div class="container">
    <h2 class="mb-4">SWES Reservation Module</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="swesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="uc-r1-tab" data-bs-toggle="tab" data-bs-target="#uc-r1" type="button" role="tab">Створення бронювання</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="uc-r5-tab" data-bs-toggle="tab" data-bs-target="#uc-r5" type="button" role="tab">Обладнання та історія</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="uc-r12-tab" data-bs-toggle="tab" data-bs-target="#uc-r12" type="button" role="tab">Календар</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="uc-r13-tab" data-bs-toggle="tab" data-bs-target="#uc-r13" type="button" role="tab">Відправка email</button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- UC-R1: Create Reservation -->
        <div class="tab-pane fade show active" id="uc-r1" role="tabpanel">
            <form id="reservationForm">
                <div class="mb-3">
                    <label for="employeeId" class="form-label">ID Співробітника</label>
                    <input type="text" class="form-control" id="employeeId" required>
                </div>
                <div class="mb-3">
                    <label for="gearSelect" class="form-label">Обладнання</label>
                    <select class="form-select" id="gearSelect" required>
                        <option value="">Виберіть обладнання</option>
                        <option value="Boots">Boots</option>
                        <option value="Vest">Vest</option>
                        <option value="Helmet">Helmet</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="reservationDate" class="form-label">Дата бронювання</label>
                    <input type="date" class="form-control" id="reservationDate" required>
                </div>
                <button type="submit" class="btn btn-primary">Забронювати</button>
            </form>
            <div id="reservationMessage" class="mt-3"></div>
        </div>

        <!-- UC-R5: Equipment History -->
        <div class="tab-pane fade" id="uc-r5" role="tabpanel">
            <div class="row mb-3">
                <div class="col-md-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Пошук по імені/ID">
                </div>
                <div class="col-md-2">
                    <select id="gearFilter" class="form-select">
                        <option value="">Усі типи</option>
                        <option value="Boots">Boots</option>
                        <option value="Vest">Vest</option>
                        <option value="Helmet">Helmet</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="date" id="startDate" class="form-control" placeholder="Дата з">
                    <input type="date" id="endDate" class="form-control mt-1" placeholder="Дата по">
                </div>
                <div class="col-md-2">
                    <select id="statusFilter" class="form-select">
                        <option value="">Всі статуси</option>
                        <option value="Returned">Returned</option>
                        <option value="Pending">Pending</option>
                        <option value="Overdue">Overdue</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="pageSize" class="form-select">
                        <option value="10">10 рядків</option>
                        <option value="25">25 рядків</option>
                        <option value="50">50 рядків</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive position-relative">
                <table class="table table-bordered table-hover" id="equipmentTable">
                    <thead>
                        <tr>
                            <th data-sort="date">Дата</th>
                            <th data-sort="gear">Обладнання</th>
                            <th data-sort="status">Статус</th>
                            <th data-sort="returnDate">Дата повернення</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="loadingSpinner" class="text-center mt-2" style="display:none;">Завантаження...</div>
                <div id="emptyMessage" class="text-center mt-2" style="display:none;">Дані відсутні</div>
            </div>
        </div>

        <!-- UC-R12: Calendar -->
        <div class="tab-pane fade" id="uc-r12" role="tabpanel">
            <div id="calendar" class="mb-3"></div>
            <p>Клік по даті заповнить форму бронювання.</p>
        </div>

        <!-- UC-R13: Email Notification -->
        <div class="tab-pane fade" id="uc-r13" role="tabpanel">
            <button class="btn btn-success" id="sendEmailBtn">Відправити Email</button>
            <div id="emailMessage" class="mt-3"></div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ===== UC-R1: Create Reservation ===== */
document.getElementById('reservationForm').addEventListener('submit', function(e){
    e.preventDefault();
    const employeeId = document.getElementById('employeeId').value.trim();
    const gear = document.getElementById('gearSelect').value;
    const date = document.getElementById('reservationDate').value;
    const today = new Date().toISOString().split('T')[0];

    if(!employeeId || !gear || !date){
        alert('Заповніть всі поля!');
        return;
    }
    if(date < today){
        alert('Дата не може бути в минулому');
        return;
    }

    // Симуляція POST
    fetch('/api/reservations', { method:'POST', body: JSON.stringify({employeeId, gear, date}) })
        .then(()=> Promise.resolve())
        .then(()=>{
            document.getElementById('reservationMessage').innerHTML = `<div class="alert alert-success">Бронювання успішне!</div>`;
            // Додати до історії для UC-R5
            reservations.push({date, gear, status:'Pending', returnDate:''});
            renderTable();
        });
});

/* ===== UC-R5: Equipment History ===== */
let reservations = [
    {date:'2025-08-18', gear:'Boots', status:'Returned', returnDate:'2025-08-20'},
    {date:'2025-08-15', gear:'Vest', status:'Pending', returnDate:''},
    {date:'2025-08-10', gear:'Helmet', status:'Overdue', returnDate:''},
];

const tableBody = document.querySelector('#equipmentTable tbody');
const loadingSpinner = document.getElementById('loadingSpinner');
const emptyMessage = document.getElementById('emptyMessage');

function renderTable(){
    loadingSpinner.style.display='block';
    setTimeout(()=>{
        loadingSpinner.style.display='none';
        let filtered = reservations.filter(r=>{
            const search = document.getElementById('searchInput').value.toLowerCase();
            const gearFilter = document.getElementById('gearFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            if(search && !r.gear.toLowerCase().includes(search)) return false;
            if(gearFilter && r.gear!==gearFilter) return false;
            if(statusFilter && r.status!==statusFilter) return false;
            if(start && r.date<start) return false;
            if(end && r.date>end) return false;
            return true;
        });

        tableBody.innerHTML = '';
        if(filtered.length===0){
            emptyMessage.style.display='block';
            return;
        } else emptyMessage.style.display='none';

        const pageSize = parseInt(document.getElementById('pageSize').value);
        filtered.slice(0,pageSize).forEach(r=>{
            tableBody.innerHTML += `<tr>
                <td>${r.date}</td>
                <td>${r.gear}</td>
                <td>${r.status}</td>
                <td>${r.returnDate || '-'}</td>
            </tr>`;
        });
    }, 300);
}

document.querySelectorAll('#searchInput, #gearFilter, #statusFilter, #startDate, #endDate, #pageSize').forEach(el=>{
    el.addEventListener('input', renderTable);
});
renderTable();

/* ===== UC-R12: Calendar ===== */
const calendarDiv = document.getElementById('calendar');
function renderCalendar(){
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const firstDay = new Date(year, month,1).getDay();
    const daysInMonth = new Date(year, month+1,0).getDate();

    let html = '<div class="d-flex flex-wrap gap-1">';
    for(let i=0;i<firstDay;i++) html += '<div style="width:14%">&nbsp;</div>';
    for(let d=1; d<=daysInMonth; d++){
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        html += `<button class="btn btn-outline-primary btn-sm m-1" style="width:14%" onclick="selectDate('${dateStr}')">${d}</button>`;
    }
    html += '</div>';
    calendarDiv.innerHTML = html;
}
function selectDate(date){
    document.getElementById('reservationDate').value = date;
}
renderCalendar();

/* ===== UC-R13: Email Notification ===== */
document.getElementById('sendEmailBtn').addEventListener('click', ()=>{
    fetch('/api/notify').then(()=> Promise.resolve()).then(()=>{
        document.getElementById('emailMessage').innerHTML = '<div class="alert alert-success">Email надіслано!</div>';
    });
});
</script>
</body>
</html>
